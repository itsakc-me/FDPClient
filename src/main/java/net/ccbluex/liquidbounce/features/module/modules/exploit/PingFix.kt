/*
 * FDPClient Hacked Client
 * A free open source mixin-based injection hacked client for Minecraft using Minecraft Forge.
 * https://github.com/SkidderMC/FDPClient/
 */
package net.ccbluex.liquidbounce.features.module.modules.exploit

import net.ccbluex.liquidbounce.event.PacketEvent
import net.ccbluex.liquidbounce.event.handler
import net.ccbluex.liquidbounce.features.module.Category
import net.ccbluex.liquidbounce.features.module.Module
import net.ccbluex.liquidbounce.utils.client.PacketUtils.sendPacket
import net.minecraft.network.play.client.C00PacketKeepAlive
import net.minecraft.network.play.client.C0FPacketConfirmTransaction
import net.minecraft.network.play.server.S00PacketKeepAlive
import net.minecraft.network.play.server.S32PacketConfirmTransaction

/**
 * PingFix module - Cosmetic ping fix for accurate ping display
 *
 * This module immediately sends responses to server transaction and keepalive
 * packets, making the server's ping calculation show your actual latency.
 *
 * Works alongside FakeLag/Blink - those modules can still delay packets normally,
 * but your displayed ping will remain accurate (cosmetic feature).
 *
 * The server uses the first response for ping calculation, so immediate response
 * = low ping display, while any delayed responses are ignored or update later.
 *
 * @author itsakc-me
 */
object PingFix : Module("PingFix", Category.EXPLOIT, Category.SubCategory.EXPLOIT_EXTRAS) {

    // Fix transaction packet responses (S32 -> C0F)
    private val transactions by boolean("Transactions", true)

    // Fix keepalive packet responses (S00 -> C00)
    private val keepAlive by boolean("KeepAlive", true)

    val onPacket = handler<PacketEvent>(priority = -10) { event ->
        if (event.isCancelled || mc.thePlayer == null || mc.netHandler == null)
            return@handler

        val packet = event.packet

        // Handle transaction packets - send immediate response
        // Don't cancel event - let normal processing continue (for FakeLag compatibility)
        if (transactions && packet is S32PacketConfirmTransaction) {
            event.cancelEvent()

            // Immediately send the confirmation response for accurate ping display
            sendPacket(
                C0FPacketConfirmTransaction(
                    packet.windowId,
                    packet.actionNumber,
                    true
                ),
                false // Don't trigger event to avoid loops
            )
        }

        // Handle keepalive packets - send immediate response
        // Don't cancel event - let normal processing continue (for FakeLag compatibility)
        if (keepAlive && packet is S00PacketKeepAlive) {
            event.cancelEvent()

            // Immediately send the keepalive response for accurate ping display
            sendPacket(
                C00PacketKeepAlive(packet.func_149134_c()),
                false // Don't trigger event to avoid loops
            )
        }
    }
}
